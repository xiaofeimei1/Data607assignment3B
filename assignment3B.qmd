---
title: "data607assignment3B"
author: "xiaofei"
format: html
editor: visual
---

## Approach

This assignment requires time series data. I'm planning to choose a stock price dataset. , I'll load data into R, check data type of each columns. Library tidyquant provide stock price, I choose stock Apple(AAPL) for this assignment to analyze price in year 2023. To use window functions calculate moving average, I will use cumean ( ) to calcualte YTD average and lag ( ) to look back 6 days window calculate 6 days moving average. In the end I'll show result through plots.

## Data Exploration

From a glance, I have 250 rows of data which looks about right amount of total trading days in year 2023. There are 8 columns in different data type such as char, date and number. Lowest price occurred toward beginning of the year on date 1/3, and the highest price on 12/29. Overall this looks like a quality data set to work with.

```{r}

library(dplyr)
library(tidyquant)  
library(lubridate)
library(ggplot2)

stock_data <- tq_get("AAPL",
                     from = "2023-01-01",
                     to = "2023-12-31",
                     get = "stock.prices")

#check data
str(stock_data)
head(stock_data)

stock_data_clean <- stock_data |>
  select(date, close) |>  #use closeing price
  arrange(date) |>       #make sure date in order
  mutate(
    year = year(date),
    month = month(date),
    day = day(date)
  )

```

## Window Functions

Use window function, in this case cumean ( ), to calculate YTD average. First need make sure data are sorted by date , then we will calculates a value for each row based on a window of previous rows. The window expands as date moving forward.

Similarly, we will use lab ( ) function to look back 6 days window. Each row's value depends on previous rows and windows slides forward as we move through the sorted dates. I notice there are some missing values for this one, due to there aren't enough days to calculate 6 days moving average at the beginning of the year.

```{r}

library(dplyr)
library(lubridate)

stock_analysis <- stock_data_clean |>
  # ensure ordering date
  arrange(date) |>
  
  group_by(year) |>
  mutate(
    ytd_avg = cummean(close),
    day_of_year = row_number(),
    ytd_min = cummin(close),
    ytd_max = cummax(close),
    
    # 6-day 
    ma_6 = (close +
            lag(close, 1) +
            lag(close, 2) +
            lag(close, 3) +
            lag(close, 4) +
            lag(close, 5)) / 6
  )|>
  ungroup() |>
  
  mutate(
    overall_avg = mean(close, na.rm = TRUE)
  )

# Check the results
stock_analysis |>
  select(date, year, close, ytd_avg, ma_6) |>
  head(15)  
```

To show result in visualization :

```{r}

# plot for both averages
ggplot(stock_analysis, aes(x = date)) +
  geom_line(aes(y = close, color = "Daily Close"), alpha = 0.5) +
  geom_line(aes(y = ytd_avg, color = "YTD Average"), size = 1) +
  geom_line(aes(y = ma_6, color = "6-Day MA"), size = 1) +
  labs(title = "Apple Stock  YTD Average and 6-Day Moving Average",
       x = "Date", 
       y = "Price (USD)",
       color = "Metric") +
  theme_minimal() +
  scale_color_manual(values = c("Daily Close" = "gray",
                                 "YTD Average" = "blue",
                                 "6-Day MA" = "red"))
```

## Conclusion

The goal of the project is do window function on a time series data. I choose stock price because it's readyly available, well recorded with price and date. cumean ( ) and lag ( ) are both use of window function to calculate closing price of Apple stock in the chosen year - 2023. The plots shows the average price are trending up from Jan to Dec of 2023.

One small but crucial details is to make sure sort the data by date at the begin since the moving window will just expand by rows and won't be checking on the dates during the process.
